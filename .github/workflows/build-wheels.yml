name: Build Wheels

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.1.0)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-wheels:
    name: Build wheels (${{ matrix.os }}-${{ matrix.arch }}, Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.8"
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.9"
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.10"
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.11"
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.12"
            target: x86_64-unknown-linux-gnu
          # Linux aarch64 (using manylinux container)
          - os: ubuntu-latest
            arch: aarch64
            python-version: "3.8"
            target: aarch64-unknown-linux-gnu
            use-docker: true
          - os: ubuntu-latest
            arch: aarch64
            python-version: "3.9"
            target: aarch64-unknown-linux-gnu
            use-docker: true
          - os: ubuntu-latest
            arch: aarch64
            python-version: "3.10"
            target: aarch64-unknown-linux-gnu
            use-docker: true
          - os: ubuntu-latest
            arch: aarch64
            python-version: "3.11"
            target: aarch64-unknown-linux-gnu
            use-docker: true
          - os: ubuntu-latest
            arch: aarch64
            python-version: "3.12"
            target: aarch64-unknown-linux-gnu
            use-docker: true
          # macOS (universal2 wheels cover both x86_64 and arm64)
          - os: macos-latest
            arch: universal2
            python-version: "3.8"
          - os: macos-latest
            arch: universal2
            python-version: "3.9"
          - os: macos-latest
            arch: universal2
            python-version: "3.10"
          - os: macos-latest
            arch: universal2
            python-version: "3.11"
          - os: macos-latest
            arch: universal2
            python-version: "3.12"
          # Windows x86_64
          - os: windows-latest
            arch: x86_64
            python-version: "3.8"
            target: x86_64-pc-windows-msvc
          - os: windows-latest
            arch: x86_64
            python-version: "3.9"
            target: x86_64-pc-windows-msvc
          - os: windows-latest
            arch: x86_64
            python-version: "3.10"
            target: x86_64-pc-windows-msvc
          - os: windows-latest
            arch: x86_64
            python-version: "3.11"
            target: x86_64-pc-windows-msvc
          - os: windows-latest
            arch: x86_64
            python-version: "3.12"
            target: x86_64-pc-windows-msvc

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Maturin
        run: pip install maturin

      - name: Build wheel (Linux x86_64)
        if: matrix.os == 'ubuntu-latest' && matrix.arch == 'x86_64'
        run: |
          maturin build --release --out dist --interpreter python${{ matrix.python-version }} --manylinux 2014

      - name: Build wheel (Linux aarch64)
        if: matrix.os == 'ubuntu-latest' && matrix.arch == 'aarch64'
        run: |
          # Use manylinux container for aarch64 cross-compilation
          # The manylinux_2_28 container supports aarch64 and has Python pre-installed
          # Convert Python version (e.g., "3.8" -> "38") for manylinux paths
          PY_VER=$(echo "${{ matrix.python-version }}" | tr -d '.')
          docker run --rm \
            -v "$PWD:/io" \
            -w /io \
            quay.io/pypa/manylinux_2_28_aarch64:latest \
            /bin/bash -c " \
            /opt/python/cp${PY_VER}-cp${PY_VER}/bin/pip install maturin && \
            /opt/python/cp${PY_VER}-cp${PY_VER}/bin/maturin build \
              --release \
              --out /io/dist \
              --interpreter /opt/python/cp${PY_VER}-cp${PY_VER}/bin/python \
              --target ${{ matrix.target }} \
              --manylinux 2_28 \
            "

      - name: Build wheel (macOS universal2)
        if: matrix.os == 'macos-latest'
        run: |
          # Build universal2 wheel for macOS (supports both x86_64 and arm64)
          maturin build --release --out dist --interpreter python${{ matrix.python-version }} --universal2

      - name: Build wheel (Windows x86_64)
        if: matrix.os == 'windows-latest'
        run: |
          maturin build --release --out dist --interpreter python${{ matrix.python-version }} --target ${{ matrix.target }}

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}-${{ matrix.arch }}-py${{ matrix.python-version }}
          path: dist/*.whl
          retention-days: 7

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build-wheels
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Get tag name
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Check for wheels
        id: check-wheels
        run: |
          if [ -z "$(find dist -name '*.whl' 2>/dev/null)" ]; then
            echo "No wheels found in dist directory"
            exit 1
          fi
          echo "Found wheels:"
          find dist -name '*.whl' -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          files: dist/**/*.whl
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

