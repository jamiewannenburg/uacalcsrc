name: Build Wheels

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.1.0)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-wheels:
    name: Build wheels (${{ matrix.os }}-${{ matrix.arch }}, Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.8"
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.9"
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.10"
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.11"
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.12"
            target: x86_64-unknown-linux-gnu
          # Linux aarch64 (using manylinux container)
          - os: ubuntu-latest
            arch: aarch64
            python-version: "3.8"
            target: aarch64-unknown-linux-gnu
            use-docker: true
          - os: ubuntu-latest
            arch: aarch64
            python-version: "3.9"
            target: aarch64-unknown-linux-gnu
            use-docker: true
          - os: ubuntu-latest
            arch: aarch64
            python-version: "3.10"
            target: aarch64-unknown-linux-gnu
            use-docker: true
          - os: ubuntu-latest
            arch: aarch64
            python-version: "3.11"
            target: aarch64-unknown-linux-gnu
            use-docker: true
          - os: ubuntu-latest
            arch: aarch64
            python-version: "3.12"
            target: aarch64-unknown-linux-gnu
            use-docker: true
          # macOS (universal2 wheels cover both x86_64 and arm64)
          - os: macos-latest
            arch: universal2
            python-version: "3.8"
          - os: macos-latest
            arch: universal2
            python-version: "3.9"
          - os: macos-latest
            arch: universal2
            python-version: "3.10"
          - os: macos-latest
            arch: universal2
            python-version: "3.11"
          - os: macos-latest
            arch: universal2
            python-version: "3.12"
          # Windows x86_64
          - os: windows-latest
            arch: x86_64
            python-version: "3.8"
            target: x86_64-pc-windows-msvc
          - os: windows-latest
            arch: x86_64
            python-version: "3.9"
            target: x86_64-pc-windows-msvc
          - os: windows-latest
            arch: x86_64
            python-version: "3.10"
            target: x86_64-pc-windows-msvc
          - os: windows-latest
            arch: x86_64
            python-version: "3.11"
            target: x86_64-pc-windows-msvc
          - os: windows-latest
            arch: x86_64
            python-version: "3.12"
            target: x86_64-pc-windows-msvc

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Maturin
        run: pip install maturin

      - name: Build wheel (Linux x86_64)
        if: matrix.os == 'ubuntu-latest' && matrix.arch == 'x86_64'
        run: |
          # Use manylinux container for x86_64 to ensure manylinux2014 compliance
          PY_VER=$(echo "${{ matrix.python-version }}" | tr -d '.')
          docker run --rm \
            -v "$PWD:/io" \
            -w /io \
            quay.io/pypa/manylinux2014_x86_64:latest \
            /bin/bash -c " \
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y && \
            source \$HOME/.cargo/env && \
            /opt/python/cp${PY_VER}-cp${PY_VER}/bin/pip install maturin && \
            /opt/python/cp${PY_VER}-cp${PY_VER}/bin/maturin build \
              --release \
              --out /io/dist \
              --interpreter /opt/python/cp${PY_VER}-cp${PY_VER}/bin/python \
              --target ${{ matrix.target }} \
              --manylinux 2014 \
            "

      - name: Set up QEMU for aarch64
        if: matrix.os == 'ubuntu-latest' && matrix.arch == 'aarch64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build wheel (Linux aarch64)
        if: matrix.os == 'ubuntu-latest' && matrix.arch == 'aarch64'
        run: |
          # Use manylinux container for aarch64 cross-compilation with QEMU emulation
          # The manylinux_2_28 container supports aarch64 and has Python pre-installed
          # Convert Python version (e.g., "3.8" -> "38") for manylinux paths
          PY_VER=$(echo "${{ matrix.python-version }}" | tr -d '.')
          docker run --rm \
            --platform linux/arm64 \
            -v "$PWD:/io" \
            -w /io \
            quay.io/pypa/manylinux_2_28_aarch64:latest \
            /bin/bash -c " \
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y && \
            source \$HOME/.cargo/env && \
            /opt/python/cp${PY_VER}-cp${PY_VER}/bin/pip install maturin && \
            /opt/python/cp${PY_VER}-cp${PY_VER}/bin/maturin build \
              --release \
              --out /io/dist \
              --interpreter /opt/python/cp${PY_VER}-cp${PY_VER}/bin/python \
              --target ${{ matrix.target }} \
              --manylinux 2_28 \
            "

      - name: Install Rust targets for macOS
        if: matrix.os == 'macos-latest'
        run: |
          rustup target add x86_64-apple-darwin
          rustup target add aarch64-apple-darwin

      - name: Build wheel (macOS universal2)
        if: matrix.os == 'macos-latest'
        run: |
          # Build universal2 wheel for macOS (supports both x86_64 and arm64)
          # Build for both architectures and merge them using lipo
          mkdir -p dist temp_x86_64 temp_arm64 temp_universal
          
          # Build for x86_64
          maturin build --release --out temp_x86_64 --interpreter python${{ matrix.python-version }} --target x86_64-apple-darwin
          X86_64_WHL=$(ls temp_x86_64/*x86_64*.whl 2>/dev/null | head -1)
          if [ -z "$X86_64_WHL" ]; then
            echo "Error: x86_64 wheel not found"
            ls -la temp_x86_64/
            exit 1
          fi
          
          # Build for aarch64 (arm64)
          maturin build --release --out temp_arm64 --interpreter python${{ matrix.python-version }} --target aarch64-apple-darwin
          ARM64_WHL=$(ls temp_arm64/*arm64*.whl 2>/dev/null | head -1)
          if [ -z "$ARM64_WHL" ]; then
            echo "Error: arm64 wheel not found"
            ls -la temp_arm64/
            exit 1
          fi
          
          # Install wheel package for unpacking/repacking
          pip install wheel
          
          # Extract both wheels
          echo "Extracting x86_64 wheel: $X86_64_WHL"
          python -m zipfile -e "$X86_64_WHL" temp_x86_64/extracted
          echo "Extracting arm64 wheel: $ARM64_WHL"
          python -m zipfile -e "$ARM64_WHL" temp_arm64/extracted
          
          # Copy x86_64 wheel structure to universal
          cp -r temp_x86_64/extracted/* temp_universal/
          
          # Find and merge .so/.dylib files using lipo
          for x86_lib in $(find temp_x86_64/extracted -type f \( -name "*.so" -o -name "*.dylib" \)); do
            rel_path=${x86_lib#temp_x86_64/extracted/}
            arm64_lib="temp_arm64/extracted/$rel_path"
            if [ -f "$arm64_lib" ]; then
              lipo -create "$x86_lib" "$arm64_lib" -output "temp_universal/$rel_path"
            fi
          done
          
          # Update WHEEL metadata and generate universal2 wheel filename using Python
          python << EOF
          import re
          import os
          from pathlib import Path
          
          x86_64_whl = "$X86_64_WHL"
          
          # Find WHEEL file
          wheel_files = list(Path("temp_universal").glob("*.dist-info/WHEEL"))
          if wheel_files:
              wheel_file = wheel_files[0]
              content = wheel_file.read_text()
              # Replace platform tags
              content = re.sub(r'macosx_\d+_\d+_x86_64', 'macosx_10_9_universal2', content)
              content = re.sub(r'macosx_\d+_\d+_arm64', 'macosx_10_9_universal2', content)
              wheel_file.write_text(content)
          
          # Generate universal2 wheel filename
          x86_64_base = os.path.basename(x86_64_whl)
          universal_whl = re.sub(r'macosx_\d+_\d+_x86_64', 'macosx_10_9_universal2', x86_64_base)
          with open("universal_whl_name.txt", "w") as f:
              f.write(universal_whl)
          EOF
          UNIVERSAL_WHL=$(cat universal_whl_name.txt)
          rm -f universal_whl_name.txt
          
          # Repack the wheel
          cd temp_universal
          python -m zipfile -c "../dist/$UNIVERSAL_WHL" *
          cd ..
          
          # Cleanup
          rm -rf temp_x86_64 temp_arm64 temp_universal

      - name: Build wheel (Windows x86_64)
        if: matrix.os == 'windows-latest'
        run: |
          maturin build --release --out dist --interpreter python${{ matrix.python-version }} --target ${{ matrix.target }}

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}-${{ matrix.arch }}-py${{ matrix.python-version }}
          path: dist/*.whl
          retention-days: 7

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build-wheels
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Get tag name
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Check for wheels
        id: check-wheels
        run: |
          if [ -z "$(find dist -name '*.whl' 2>/dev/null)" ]; then
            echo "No wheels found in dist directory"
            exit 1
          fi
          echo "Found wheels:"
          find dist -name '*.whl' -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          files: dist/**/*.whl
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

